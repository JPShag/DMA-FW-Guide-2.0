# 固件修改清单

使用此清单来指导您的固件创建过程。

---

## **1. 收集捐赠设备信息**

从捐赠的PCIe设备收集以下信息：

- [ ] **设备ID** (`0xXXXX`)
- [ ] **供应商ID** (`0xYYYY`)
- [ ] **子系统ID** (`0xZZZZ`)
- [ ] **子系统供应商ID** (`0xWWWW`)
- [ ] **修订ID** (`0xRR`)
- [ ] **类代码** (`0xCCCCCC`)
- [ ] **基地址寄存器（BARs）配置**：
  - [ ] **BAR0**至**BAR5**的大小、类型（内存或I/O）、可预取状态
- [ ] **功能**：
  - [ ] 电源管理设置
  - [ ] MSI/MSI-X设置
- [ ] **设备序列号（DSN）** (`0xXXXXXXXXYYYYYYYY`)

---

## **2. 修改固件配置文件**

### **2.1. 打开固件配置文件**

- [ ] **要编辑的文件**：`pcileech_pcie_cfg_a7.sv`
- [ ] **位置**：`pcileech-fpga/pcileech-wifi-main/src/pcileech_pcie_cfg_a7.sv`

### **2.2. 更新设备和供应商ID**

- [ ] **修改** `cfg_deviceid`：

  ```verilog
  cfg_deviceid <= 16'hXXXX;  // 将XXXX替换为捐赠设备的设备ID
  ```

- [ ] **修改** `cfg_vendorid`：

  ```verilog
  cfg_vendorid <= 16'hYYYY;  // 将YYYY替换为捐赠设备的供应商ID
  ```

### **2.3. 更新子系统ID和修订ID**

- [ ] **修改** `cfg_subsysid`：

  ```verilog
  cfg_subsysid <= 16'hZZZZ;  // 将ZZZZ替换为捐赠设备的子系统ID
  ```

- [ ] **修改** `cfg_subsysvendorid`：

  ```verilog
  cfg_subsysvendorid <= 16'hWWWW;  // 将WWWW替换为捐赠设备的子系统供应商ID
  ```

- [ ] **修改** `cfg_revisionid`：

  ```verilog
  cfg_revisionid <= 8'hRR;  // 将RR替换为捐赠设备的修订ID
  ```

### **2.4. 更新类代码**

- [ ] **修改** `cfg_classcode`：

  ```verilog
  cfg_classcode <= 24'hCCCCCC;  // 将CCCCCC替换为捐赠设备的类代码
  ```

### **2.5. 插入设备序列号（DSN）**

- [ ] **修改** `cfg_dsn`：

  ```verilog
  cfg_dsn <= 64'hXXXXXXXXYYYYYYYY;  // 替换为捐赠设备的DSN
  ```

---

## **3. 定制Vivado项目**

### **3.1. 生成Vivado项目文件**

- [ ] **打开Vivado**，并在Tcl控制台中运行相应的Tcl脚本：

  ```tcl
  cd <project_directory>
  source vivado_generate_project_<your_board>.tcl -notrace
  ```

  - 将`<project_directory>`替换为您的项目路径。
  - 将`<your_board>`替换为您的FPGA板标识符（例如，`squirrel`）。

### **3.2. 打开生成的项目**

- [ ] **文件**：在Vivado中打开生成的`.xpr`项目文件。

---

## **4. 修改PCIe IP核**

### **4.1. 打开PCIe IP核配置**

- [ ] **要编辑的文件**：`pcie_7x_0.xci`
- [ ] **操作**：右键点击并选择**定制IP**。

### **4.2. 设置设备标识符**

- [ ] **设备ID**：设置为捐赠设备的设备ID。
- [ ] **供应商ID**：设置为捐赠设备的供应商ID。
- [ ] **子系统ID**：设置为捐赠设备的子系统ID。
- [ ] **子系统供应商ID**：设置为捐赠设备的子系统供应商ID。
- [ ] **修订ID**：设置为捐赠设备的修订ID。
- [ ] **类代码**：设置为捐赠设备的类代码。

### **4.3. 配置BARs**

对于每个BAR（BAR0至BAR5）：

- [ ] **启用/禁用**：与捐赠设备匹配。
- [ ] **类型**：内存（32位或64位）或I/O。
- [ ] **大小**：设置为捐赠设备的BAR大小。
- [ ] **可预取**：与捐赠设备的设置匹配。

### **4.4. 匹配PCIe链路参数**

- [ ] **最大链路速度**：设置为匹配捐赠设备（例如，**Gen2**、**Gen3**）。
- [ ] **链路宽度**：设置为匹配捐赠设备（例如，**x1**、**x4**）。

### **4.5. 配置功能**

- [ ] **启用电源管理**（如果捐赠设备支持）。
- [ ] **启用MSI/MSI-X**（如果捐赠设备支持）。

### **4.6. 应用更改并锁定IP核**

- [ ] **应用**：点击**OK**保存IP核设置。
- [ ] **锁定IP核**：在Tcl控制台中运行：

  ```tcl
  set_property -name {IP_LOCKED} -value true -objects [get_ips pcie_7x_0]
  ```

---

## **5. 为高级功能调整固件**

### **5.1. 更新能力指针**

- [ ] **要编辑的文件**：`pcileech_pcie_cfg_a7.sv`
- [ ] **修改** `cfg_cap_pointer`：

  ```verilog
  cfg_cap_pointer <= 8'hXX;  // 将XX替换为捐赠设备的能力指针
  ```

### **5.2. 调整最大有效载荷和读取请求大小**

- [ ] **在PCIe IP核中**：将**最大有效载荷大小**和**最大读取请求大小**设置为匹配捐赠设备。

- [ ] **在固件中（`pcileech_pcie_cfg_a7.sv`）**：

  ```verilog
  max_payload_size_supported <= 3'bYYY;  // 二进制值，对应于捐赠设备的最大有效载荷大小
  ```

  - **映射关系**：

    | 有效载荷大小（字节） | 二进制值   |
    |----------------------|------------|
    | 128                  | `3'b000`   |
    | 256                  | `3'b001`   |
    | 512                  | `3'b010`   |
    | 1024                 | `3'b011`   |
    | 2048                 | `3'b100`   |
    | 4096                 | `3'b101`   |

### **5.3. 实现电源管理逻辑**

- [ ] **要编辑的文件**：`pcileech_pcie_cfg_a7.sv`
- [ ] **添加逻辑**以处理电源状态转换（如果适用）。

### **5.4. 实现MSI/MSI-X中断**

- [ ] **在PCIe IP核中**：启用MSI或MSI-X功能，并设置支持的向量数量。

- [ ] **在固件中（`pcileech_pcie_tlp_a7.sv`）**：

  - [ ] **添加中断逻辑**以处理MSI/MSI-X中断。

---

## **6. 调整固件中的BAR处理**

### **6.1. 打开BAR控制器文件**

- [ ] **要编辑的文件**：`pcileech_tlps128_bar_controller.sv`
- [ ] **位置**：`pcileech-fpga/pcileech-wifi-main/src/pcileech_tlps128_bar_controller.sv`

### **6.2. 更新BAR地址解码**

- [ ] **修改**地址解码逻辑，以匹配捐赠设备的BAR大小和地址。

### **6.3. 实现BAR访问逻辑**

对于每个启用的BAR：

- [ ] **实现读/写处理程序**，对应于BAR的用途。

---

## **7. 实现TLP处理**

### **7.1. 打开TLP处理文件**

- [ ] **要编辑的文件**：`pcileech_pcie_tlp_a7.sv`

### **7.2. 修改TLP处理逻辑**

- [ ] **实现**处理捐赠设备所需的特定TLP类型的逻辑：

  - [ ] 内存读取请求
  - [ ] 内存写入请求
  - [ ] 配置读取/写入请求
  - [ ] 供应商定义的消息

### **7.3. 确保TLP合规**

- [ ] **验证**TLP按照PCIe规范正确格式化。

---

## **8. 构建并烧录固件**

### **8.1. 运行综合和实现**

在Vivado中：

- [ ] **运行综合**
- [ ] **运行实现**
- [ ] **生成比特流**

### **8.2. 编程FPGA**

- [ ] **通过JTAG连接**您的FPGA设备。
- [ ] **打开硬件管理器**。
- [ ] **使用生成的比特流编程设备**。

---

## **9. 测试与验证**

### **9.1. 验证设备枚举**

- [ ] **检查**FPGA是否在主机系统上显示为捐赠设备。

### **9.2. 安装必要的驱动程序**

- [ ] **使用**捐赠设备的驱动程序（如果需要）。

### **9.3. 执行功能测试**

- [ ] **测试**捐赠设备预期的所有功能。

### **9.4. 监控错误**

- [ ] **检查**系统日志中与设备相关的任何错误或警告。

---

## **10. 根据需要调试和优化**

### **10.1. 使用集成逻辑分析器（ILA）**

- [ ] **插入**ILA核以监控内部信号（如果必要）。

### **10.2. 分析PCIe流量**

- [ ] **使用**PCIe协议分析仪，调试通信问题。

### **10.3. 精炼固件**

- [ ] **迭代**您的固件代码，修复错误并提高性能。
